# Template file for 'thorium-reader-bin'
pkgname=thorium-reader-bin
version=3.3.0
revision=1
archs="x86_64"

# Verify exact filename on each release; adjust if upstream changes it
distfiles="https://github.com/edrlab/thorium-reader/releases/download/v${version}/Thorium-${version}.AppImage"
checksum=9fafcb0285a0bf2b49f8cd0b11a779602c4ec8d92179743f09e2de5b6449bb9e


skip_extraction=yes


short_desc="Thorium Reader EPUB reader (official AppImage)"
maintainer="yourname <you@example.invalid>"
license="BSD-3-Clause"
homepage="https://www.edrlab.org/software/thorium-reader/"
nostrip=yes

do_extract() {
	:
}

do_install() {
	appimage="Thorium-${version}.AppImage"

	# distfile is usually in the distfiles cache, not /host/sources, since we skip extract
	for d in "${XBPS_DISTFILES_DIR}" "${XBPS_DISTDIR}" "${XBPS_SRCDISTDIR}" "${wrksrc}" "."; do
		[ -n "$d" ] || continue
		if [ -f "${d}/${appimage}" ]; then
			appimage_path="${d}/${appimage}"
			break
		fi
	done

	if [ -z "${appimage_path}" ]; then
		echo "ERROR: could not find ${appimage} in distfiles/source dirs" >&2
		echo "Tried: XBPS_DISTFILES_DIR='${XBPS_DISTFILES_DIR}' XBPS_DISTDIR='${XBPS_DISTDIR}' XBPS_SRCDISTDIR='${XBPS_SRCDISTDIR}' wrksrc='${wrksrc}'" >&2
		return 1
	fi

	vmkdir opt/thorium-reader
	vcopy "${appimage_path}" "opt/thorium-reader/ThoriumReader.AppImage"
	chmod 0755 "${DESTDIR}/opt/thorium-reader/ThoriumReader.AppImage"

	# Wrapper in PATH
	vmkdir usr/bin
	cat > "${DESTDIR}/usr/bin/thorium-reader" <<'EOF'
#!/bin/sh
exec /opt/thorium-reader/ThoriumReader.AppImage "$@"
EOF
	chmod 0755 "${DESTDIR}/usr/bin/thorium-reader"

	# Desktop entry
	vmkdir usr/share/applications
	cat > "${DESTDIR}/usr/share/applications/thorium-reader.desktop" <<'EOF'
[Desktop Entry]
Type=Application
Name=Thorium Reader
Comment=EPUB reader
Exec=thorium-reader %u
Terminal=false
Categories=Office;Education;Viewer;
EOF
}
